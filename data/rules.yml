version: "2.0"
rules:
# ----- SECOND QUERY -----
  - rule: run second query
    steps:
    - action: action_query_knowledgebase_cases
    - intent: query_regulations
    - action: action_validate_transit
    wait_for_user_input: false

  - rule: 2nd query
    steps:
    - action: action_validate_transit
    - action: action_query_knowledgebase_cases
  - rule: 2nd query LU+plane
    condition:
    - slot_was_set:
      - transport_type: plane
      - country_to: Luxembourg
    steps:
    - action: action_validate_transit
    - action: transport_sector_worker_form
    - active_loop: null
    - action: action_query_knowledgebase_cases


  - rule: local_rules_form interrupt
    condition:
    - active_loop: local_regulations_form
    - slot_was_set:
      - requested_slot: indoors/outdoors
    steps:
    - intent: nothing_else
    - action: local_regulations_form
    - active_loop: null
    - action: utter_goodbye


  - rule: user wants nothing
    steps:
    - intent: nothing_else
    - action: utter_goodbye
  - rule: country_form interrupt
    condition:
    - active_loop: country_form
    steps:
    - intent: ask_which_countries
    - action: utter_list_the_countries
    - action: country_form
    - active_loop: country_form
  - rule: regulation_type_form interrupt
    condition:
    - active_loop: regulation_type_form
    steps:
    - intent: nothing_else
    - action: regulation_type_form
    - active_loop: null
    - action: utter_goodbye
  - rule: details on test
    steps:
    - intent: test_details
    - action: action_query_knowledgebase_cases
  - rule: return
    steps:
    - intent: go_back
    - action: action_go_back
  #- rule: fallback
    #steps:
    #- action: action_default_fallback_custom
    #- action: action_listen

  - rule: validate countries
    steps:
    - intent: query_regulations
    - action: action_validate_countries
    wait_for_user_input: false

  - rule: wrong country_to extracted
    condition:
    - slot_was_set:
      - country_to: None
    steps:
    - action: action_validate_countries
    - action: utter_not_understood
    - action: country_form
    - active_loop: country_form
  - rule: wrong country_from extracted
    condition:
    - slot_was_set:
      - country_from: None
    steps:
    - action: action_validate_countries
    - action: utter_not_understood
    - action: country_form
    - active_loop: country_form
  - rule: correct countries extracted
    condition:
    - slot_was_set:
      - entity_type: entry_regulations
    steps:
    - action: action_validate_countries
    - action: country_form
    - active_loop: country_form

  - rule: submit country_form//activate confirm_country_form
    condition:
    - active_loop: country_form
    steps:
    - action: country_form
    - active_loop: null
    - action: action_check_borders
    - action: confirm_country_form
    - active_loop: confirm_country_form

  - rule: correct the countries
    condition:
    - active_loop: confirm_country_form
    - slot_was_set:
      - correct_countries: false
    steps:
    - action: confirm_country_form
    - active_loop: null
    - slot_was_set:
      - requested_slot: null
    - action: action_clear_countries
    - action: country_form_II
    - active_loop: country_form_II



#--------BASIC-CONVERSATION-MANAGEMENT--------
  - rule: greet
    steps:
      - intent: greet
      - action: utter_greet
  - rule: greet at the beggining
    conversation_start: true
    steps:
      - intent: greet
      - action: utter_greet
      - action: utter_welcome_message
      - action: action_utter_disclaimer
      #- action: utter_type_restart
      - action: regulation_type_form
      - active_loop: regulation_type_form
  - rule: going to main_menu
    steps:
    - intent: main_menu
    - action: action_reset_entity_type
    - action: regulation_type_form
    - active_loop: regulation_type_form
  - rule: choose regulations type
    condition:
    - active_loop: regulation_type_form
    - slot_was_set:
      - entity_type: entry_regulations
    steps:
    - action: regulation_type_form
    - active_loop: null
    #- slot_was_set:
    #  - requested_slot: null
    - action: utter_ask_trip_details
    #- action: utter_ask_additional
  - rule: goodbye
    steps:
      - intent: goodbye
      - action: utter_goodbye
  - rule: thank you
    steps:
      - intent: thank_you
      - action: utter_ur_welcome
  - rule: wellbeing check
    steps:
      - intent: wellbeing_check
      - action: utter_mood
  - rule: bot challenge
    steps:
      - intent: bot_challenge
      - action: utter_iamabot
  - rule: inqury about other countries
    steps:
      - intent: ask_other_countries
      - action: utter_answer_for_other_countries
  - rule: user asks to list the countries
    steps:
      - intent: ask_which_countries
      - action: utter_list_the_countries
  - rule: user asks functionality
    steps:
      - intent: what_can_u_do
      - action: utter_explain_functionality
  - rule: reeating
    steps:
      - intent: repeat_please
      - action: action_repeat_last




#--------------------------------------------
  - rule: second thank you
    condition:
    - slot_was_set:
      - entity_type: local_regulations
    steps:
    - intent: thank_you
    - action: utter_ur_welcome
    - action: utter_prompt_continue
  #  - action: continue_form
  #  - active_loop: continue_form
  #- rule: end of convo
   # condition:
   # - active_loop: continue_form
   # - slot_was_set:
   #   - want_to_continue: false
   # steps:
   # - action: continue_form
   # - active_loop: null
   # - slot_was_set:
   #   - requested_slot: null
   # - action: utter_goodbye

  #- rule: end of convo
   # condition:
   # - active_loop: continue_form
   # - slot_was_set:
   #   - want_to_continue: true
   # steps:
   # - action: continue_form
   # - active_loop: null
   # - slot_was_set:
   #   - requested_slot: null
   # - action: utter_prompt_continue

  - rule: first thank you
    condition:
    - slot_was_set:
      - query_counter: 1
      - entity_type: entry_regulations
    steps:
    - intent: thank_you
    - action: utter_ur_welcome
    - action: want_local_info_form
    - active_loop: want_local_info_form
  - rule: end of convo afetr local info
    condition:
    - slot_was_set:
      - want_localinfo: false
    steps:
      - action: want_local_info_form
      - active_loop: null
      - slot_was_set:
        - requested_slot: null
      #- action: utter_goodbye
      - action: utter_prompt_continue
      #- active_loop: continue_form
  - rule: don't continue
    steps:
    - action: utter_prompt_continue
    - intent: deny
    - action: utter_goodbye

  - rule: continue convo
    condition:
    - slot_was_set:
      - want_localinfo: true
    steps:
      - action: want_local_info_form
      - active_loop: null
      - slot_was_set:
        - requested_slot: null
      - action: local_regulations_form
      - active_loop: local_regulations_form



  - rule: confirmation success
    #condition:
    #- active_loop: confirm_form
    #- slot_was_set:
    #  - correct_info: true
    steps:
    #- action: confirm_form
    #- active_loop: null
    #- slot_was_set:
    #  - requested_slot: null
    - action: action_ask_confirm_collected_info
    - action: action_query_knowledgebase_cases


  #- rule: Submit confirm_form
  #  condition:
  #  - active_loop: confirm_form
  #  steps:
  #  - action: confirm_form
  #  - active_loop: null
  #  - slot_was_set:
  #    - requested_slot: null
  #  wait_for_user_input: false

# ==== LOCAL REGULATIONS ====
  - rule: open places query
    steps:
    - intent: query_open_places
    - action: action_set_local
    - action: action_set_open
    - action: action_query_knowledgebase_cases


  - rule: more local rules
    condition:
    - slot_was_set:
      - entity_type: local_regulations
    steps:
    - action: action_query_knowledgebase_cases
    - action: want_more_local_info_form
    - active_loop: want_more_local_info_form
  - rule: submit want_more_LI
    condition:
    - slot_was_set:
      - want_more_local_info: true
    steps:
    - action: local_regulations_form
    - active_loop: local_regulations_form

  - rule: activate local_regulations_form
    steps:
    - intent: query_local_regulations
    - action: correct_local_form
    - active_loop: correct_local_form

  - rule: denied local_regulations_form
    condition:
    - active_loop: correct_local_form
    - slot_was_set:
      - correct_info: false
    steps:
    - action: correct_local_form
    - active_loop: null
    - action: utter_rephrase

  - rule: confirmed local_regulations_form
    condition:
    - active_loop: correct_local_form
    - slot_was_set:
      - correct_info: true
    steps:
    - action: correct_local_form
    - active_loop: null
    - action: action_set_local
    - action: local_regulations_form
    - active_loop: local_regulations_form

  - rule: choose regulations type ->local
    condition:
    - active_loop: regulation_type_form
    - slot_was_set:
      - entity_type: local_regulations
    steps:
    - action: regulation_type_form
    - active_loop: null
    - action: local_regulations_form
    - active_loop: local_regulations_form

  - rule: Submit local_regulations_form (DE)
    condition:
    - active_loop: local_regulations_form
    - slot_was_set:
      - country_to: Germany
    steps:
    - action: local_regulations_form
    - active_loop: null
    - slot_was_set:
      - requested_slot: null
    - action: open_places_form
    - active_loop: open_places_form

  - rule: Submit open_places_form
    condition:
    - active_loop: open_places_form
    steps:
    - action: open_places_form
    - active_loop: null
    - action: action_query_knowledgebase_cases
    #- action: confirm_form
    #- active_loop: confirm_form
    #- action: action_query_knowledgebase_cases
    #wait_for_user_input: false

  - rule: local rules + inside
    condition:
    - active_loop: local_regulations_form
    - slot_was_set:
      - indoors/outdoors: indoors
    steps:
    - action: local_regulations_form
    - active_loop: null
    - slot_was_set:
      - requested_slot: null
    - action: open_places_form
    - active_loop: open_places_form

  - rule: Submit local_regulations_form + activate extended_local_regulations_form
    condition:
    - active_loop: local_regulations_form
   # - slot_was_set:
   #   - indoors/outdoors: outdoors
    steps:
    - action: local_regulations_form
    - active_loop: null
    - slot_was_set:
      - requested_slot: null
    - action: extended_local_regulations_form
    - active_loop: extended_local_regulations_form
  - rule: Submit extended_local_regulations_form
    condition:
    - active_loop: extended_local_regulations_form
    steps:
    - action: extended_local_regulations_form
    - active_loop: null
    - action: open_places_form
    - active_loop: open_places_form





#====== RULES FOR RUNNING THE QUERY ACTION ======
# ===== Germany =====
  - rule: <24h_rule
    condition:
    - active_loop: <24h_form
    - slot_was_set:
      - <24h: true
    steps:
    - action: <24h_form
    - active_loop: null
    - slot_was_set:
      - requested_slot: null
    - action: children_travel_form
    - active_loop: children_travel_form
    #- action: action_query_knowledgebase_cases
    wait_for_user_input: false
  - rule: leisure_rule_DE
    condition:
    - active_loop: visit_purpose_form
    - slot_was_set:
      - country_to: Germany
      - visit_purpose: leisure
    steps:
    - action: visit_purpose_form
    - active_loop: null
    - slot_was_set:
      - requested_slot: null
    - action: children_travel_form
    - active_loop: children_travel_form
    #- action: action_query_knowledgebase_cases
    wait_for_user_input: false
  - rule: family rule DE
    condition:
    - active_loop: visit_purpose_form
    - slot_was_set:
      - country_to: Germany
      - visit_purpose: family
    steps:
    - action: visit_purpose_form
    - active_loop: null
    - slot_was_set:
      - requested_slot: null
    - action: children_travel_form
    - active_loop: children_travel_form
    #- action: action_query_knowledgebase_cases
    wait_for_user_input: false



# ===== Luxembourg =====


# ===== the Netherlands =====

  - rule: NL leisure/family travel or LU not Plane
    condition:
    - active_loop: transport_type_form
    steps:
    - action: transport_type_form
    - active_loop: null
    - slot_was_set:
      - requested_slot: null
    - action: children_travel_form
    - active_loop: children_travel_form
    wait_for_user_input: false


#==== Intermediate step before collecting info ====
  - rule: intermediate step
    condition:
    - active_loop: confirm_country_form
    - slot_was_set:
      - correct_countries: true
    steps:
    - action: confirm_country_form
    - active_loop: null
    - slot_was_set:
      - requested_slot: null
    - action: utter_warn_collect_info
    wait_for_user_input: false

#====== FORMS ACTIVATION ======
  # ENTRY REGULATIONS FORMS
# ===== Going to Germany =====
  - rule: correct country->activate <24h_form II
    condition:
    #- active_loop: confirm_country_form
    - slot_was_set:
      - country_to: Germany
      - correct_countries: true
    steps:
    #- action: confirm_country_form
    #- active_loop: null
    #- slot_was_set:
    #  - requested_slot: null
    - action: utter_warn_collect_info
    - action: <24h_form
    - active_loop: <24h_form
  - rule: correct country_II->activate <24h_form II
    condition:
    - active_loop: country_form_II
    - slot_was_set:
      - country_to: Germany
    steps:
    #- action: country_form
    - action: country_form_II
    - active_loop: null
    - slot_was_set:
      - requested_slot: null
    - action: action_check_borders
    - action: <24h_form
    - active_loop: <24h_form
  - rule: DE activate visit_purpose_form
    condition:
    - active_loop: <24h_form
    - slot_was_set:
      - <24h: false
    steps:
    - action: <24h_form
    - active_loop: null
    - slot_was_set:
      - requested_slot: null
    - action: visit_purpose_form
    - active_loop: visit_purpose_form
  - rule: DE activate transport_sector_worker_form
    condition:
    - active_loop: visit_purpose_form
    - slot_was_set:
      - country_to: Germany
      - visit_purpose: work
    steps:
    - action: visit_purpose_form
    - active_loop: null
    - slot_was_set:
      - requested_slot: null
    - action: transport_sector_worker_form
    - active_loop: transport_sector_worker_form

# ===== Going to Luxembourg =====
  #- rule: LU activate transport_type_form I
  - rule: correct country->LU activate transport_type_form II
    condition:
    #- active_loop: confirm_country_form
    - slot_was_set:
      - country_to: Luxembourg
      - correct_countries: true
    steps:
    #- action: confirm_country_form
    #- active_loop: null
    #- slot_was_set:
    #  - requested_slot: null
    - action: utter_warn_collect_info
    - action: transport_type_form
    - active_loop: transport_type_form
  - rule: correct country_II->LU activate transport_type_form II
    condition:
    - active_loop: country_form_II
    - slot_was_set:
      - country_to: Luxembourg
    steps:
    - action: country_form_II
    - active_loop: null
    - slot_was_set:
      - requested_slot: null
    - action: action_check_borders
    - action: transport_type_form
    - active_loop: transport_type_form
  - rule: LU activate transport_sector_worker_form
    condition:
    - active_loop: transport_type_form
    - slot_was_set:
      - country_to: Luxembourg
      - transport_type: plane
    steps:
    - action: transport_type_form
    - active_loop: null
    - slot_was_set:
      - requested_slot: null
    - action: transport_sector_worker_form
    - active_loop: transport_sector_worker_form

# ===== Going to the Netherlands =====
  - rule: correct country->NL activate visit_purpose_form (II)
    condition:
    #- active_loop: confirm_country_form
    - slot_was_set:
      - country_to: Netherlands
      - correct_countries: true
    steps:
    #- action: confirm_country_form
    #- active_loop: null
    #- slot_was_set:
    #  - requested_slot: null
   # - action: country_form
   # - active_loop: null
    - action: utter_warn_collect_info
    - action: visit_purpose_form
    - active_loop: visit_purpose_form
  - rule: correct country_II->NL activate visit_purpose_form (II)
    condition:
    - active_loop: country_form_II
    - slot_was_set:
      - country_to: Netherlands
    steps:
    - action: country_form_II
    - active_loop: null
    - slot_was_set:
      - requested_slot: null
    - action: action_check_borders
    - action: visit_purpose_form
    - active_loop: visit_purpose_form
  - rule: NL activate NL_worker_form
    condition:
    - active_loop: visit_purpose_form
    - slot_was_set:
      - country_to: Netherlands
      - visit_purpose: work
    steps:
    - action: visit_purpose_form
    - active_loop: null
    - slot_was_set:
      - requested_slot: null
    - action: NL_worker_form
    - active_loop: NL_worker_form
  - rule: NL leisure + activate transport_type_form
    condition:
    - active_loop: visit_purpose_form
    - slot_was_set:
      - country_to: Netherlands
      - visit_purpose: leisure
    steps:
    - action: visit_purpose_form
    - active_loop: null
    - slot_was_set:
      - requested_slot: null
    - action: transport_type_form
    - active_loop: transport_type_form
  - rule: NL family + activate transport_type_form
    condition:
    - active_loop: visit_purpose_form
    - slot_was_set:
      - country_to: Netherlands
      - visit_purpose: family
    steps:
    - action: visit_purpose_form
    - active_loop: null
    - slot_was_set:
      - requested_slot: null
    - action: transport_type_form
    - active_loop: transport_type_form



# ===== Transit through Germany =====
  - rule: activate transit through Germany form (from NL to LUX + by car)
    condition:
    - active_loop: transport_type_form
    - slot_was_set:
      - country_from: Netherlands
      - country_to: Luxembourg
      - transport_type: car
    steps:
    - action: transport_type_form
    - active_loop: null
    - slot_was_set:
      - requested_slot: null
    - action: transit_DE_form
    - active_loop: transit_DE_form
  - rule: activate transit through Germany form (from NL to LUX + by coach)
    condition:
    - active_loop: transport_type_form
    - slot_was_set:
      - country_from: Netherlands
      - country_to: Luxembourg
      - transport_type: coach
    steps:
    - action: transport_type_form
    - active_loop: null
    - slot_was_set:
      - requested_slot: null
    - action: transit_DE_form
    - active_loop: transit_DE_form
  - rule: activate transit through Germany form (from LUX to NL + worker)
    condition:
    - active_loop: NL_worker_form
    - slot_was_set:
      - country_from: Luxembourg
      - country_to: Netherlands
      - visit_purpose: work
    steps:
    - action: NL_worker_form
    - active_loop: null
    - slot_was_set:
      - requested_slot: null
    - action: transit_DE_form
    - active_loop: transit_DE_form
  - rule: activate transit through Germany form (from LUX to NL + by car)
    condition:
    - active_loop: transport_type_form
    - slot_was_set:
      - country_from: Luxembourg
      - country_to: Netherlands
      - transport_type: car
    steps:
    - action: transport_type_form
    - active_loop: null
    - slot_was_set:
      - requested_slot: null
    - action: transit_DE_form
    - active_loop: transit_DE_form
  - rule: activate transit through Germany form (from LUX to NL + by coach)
    condition:
    - active_loop: transport_type_form
    - slot_was_set:
      - country_from: Luxembourg
      - country_to: Netherlands
      - transport_type: coach
    steps:
    - action: transport_type_form
    - active_loop: null
    - slot_was_set:
      - requested_slot: null
    - action: transit_DE_form
    - active_loop: transit_DE_form

#####~~~~~~~!!!!!!!!!!!!!!!!!!!!~~~~~~#####
#====== FORMS DISACTIVATION ======
  # ENTRY REGULATIONS FORMS
# ===== Germany =====
  #- rule: Submit <24h_form
  #  condition:
  #  - active_loop: <24h_form
  #  steps:
  #  - action: <24h_form
  #  - active_loop: null
  #  - slot_was_set:
  #    - requested_slot: null
  #  wait_for_user_input: false

  #- rule: DE/NL Submit visit_purpose_form
  #  condition:
  #  - active_loop: visit_purpose_form
  #  steps:
  #  - action: visit_purpose_form
  #  - active_loop: null
  #  - slot_was_set:
  #    - requested_slot: null
  #  wait_for_user_input: false

  - rule: DE/LU Submit transport_sector_worker_form + WORKER
    condition:
    - active_loop: transport_sector_worker_form
    - slot_was_set:
      - transport_sector_worker: true
    steps:
    - action: transport_sector_worker_form
    - active_loop: null
    - slot_was_set:
      - requested_slot: null
    #- action: action_ask_confirm_collected_info
    #- action: confirm_form
    #- active_loop: confirm_form
    - action: action_query_knowledgebase_cases
    #wait_for_user_input: false
  - rule: DE/LU Submit transport_sector_worker_form + NOT WORKER
    condition:
    - active_loop: transport_sector_worker_form
    - slot_was_set:
      - transport_sector_worker: false
    steps:
    - action: transport_sector_worker_form
    - active_loop: null
    - slot_was_set:
      - requested_slot: null
    - action: children_travel_form
    - active_loop: children_travel_form
    #- action: action_query_knowledgebase_cases
    #wait_for_user_input: false

# ===== Luxembourg =====

  - rule: LU/NL Submit transit_DE_form (work)
    condition:
    - slot_was_set:
      - visit_purpose: work
    - active_loop: transit_DE_form
    steps:
    - action: transit_DE_form
    - active_loop: null
    - slot_was_set:
      - requested_slot: null
    #- action: action_ask_confirm_collected_info
    #- action: confirm_form
    #- active_loop: confirm_form
    - action: action_query_knowledgebase_cases
   # wait_for_user_input: false
  - rule: LU/NL Submit transit_DE_form
    condition:
    - active_loop: transit_DE_form
    steps:
    - action: transit_DE_form
    - active_loop: null
    - slot_was_set:
      - requested_slot: null
    #- action: action_query_knowledgebase_cases
    #wait_for_user_input: false
    - action: children_travel_form
    - active_loop: children_travel_form
    #wait_for_user_input: false

# ===== the Netherlands =====
  - rule: Submit NL_worker_form
    condition:
    - active_loop: NL_worker_form
    steps:
    - action: NL_worker_form
    - active_loop: null
    - slot_was_set:
      - requested_slot: null
    #- action: action_ask_confirm_collected_info
    #- action: confirm_form
    #- active_loop: confirm_form
    - action: action_query_knowledgebase_cases
   # wait_for_user_input: false


# ===== Submit CHILDREN form =====
  - rule: Submit children_travel_form
    condition:
    - active_loop: children_travel_form
    steps:
    - action: children_travel_form
    - active_loop: null
    - slot_was_set:
      - requested_slot: null
    #- action: action_ask_confirm_collected_info
    #- action: confirm_form
    #- active_loop: confirm_form
    - action: action_query_knowledgebase_cases
   # wait_for_user_input: false